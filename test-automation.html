<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–æµ‹è¯• - ç›´æ’­é…ç½®è§£æ</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.pending {
            background: #ffeaa7;
            color: #d63031;
        }
        .status.success {
            background: #d1f2eb;
            color: #00b894;
        }
        .status.error {
            background: #fab1a0;
            color: #e17055;
        }
        .test-btn {
            background: #0984e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .test-btn:hover {
            background: #0770c5;
        }
        .test-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .iframe-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        #testFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯• - ç›´æ’­é…ç½®è§£æå™¨</h1>
            <p>æ¯æ¬¡å‘å¸ƒå‰è¿è¡Œæ­¤æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸</p>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•çŠ¶æ€</h3>
            <div id="overallStatus" class="status pending">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
            <button class="test-btn" onclick="runAllTests()">ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•</button>
            <button class="test-btn" onclick="runQuickTest()">âš¡ å¿«é€Ÿæµ‹è¯•</button>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ æµ‹è¯•ç”¨ä¾‹åŠ è½½</h3>
            <div id="testDataStatus" class="status pending">æœªåŠ è½½</div>
            <button class="test-btn" onclick="loadTestData()" id="loadTestBtn">ğŸ“¥ åŠ è½½æµ‹è¯•æ•°æ®</button>
            <div class="test-results" id="testDataResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ–¼ï¸ ä¸»ç¨‹åºåŠ è½½æµ‹è¯•</h3>
            <div id="mainAppStatus" class="status pending">æœªæµ‹è¯•</div>
            <button class="test-btn" onclick="loadMainApp()" id="loadMainBtn">ğŸ”— åŠ è½½ä¸»ç¨‹åº</button>
            <div class="iframe-container">
                <iframe id="testFrame" src="about:blank"></iframe>
            </div>
        </div>

        <div class="test-section">
            <h3>âš™ï¸ åŠŸèƒ½éªŒè¯æµ‹è¯•</h3>
            <div id="functionalStatus" class="status pending">æœªæµ‹è¯•</div>
            <button class="test-btn" onclick="runFunctionalTests()" id="functionalBtn" disabled>ğŸ”§ è¿è¡ŒåŠŸèƒ½æµ‹è¯•</button>
            <div class="test-results" id="functionalResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•æŠ¥å‘Š</h3>
            <div id="testReport" class="test-results">ç­‰å¾…æµ‹è¯•å®Œæˆ...</div>
        </div>
    </div>

    <script>
        let testData = null;
        let testResults = {
            dataLoad: false,
            appLoad: false,
            functional: false,
            startTime: null,
            endTime: null
        };

        // åŠ è½½æµ‹è¯•æ•°æ®
        async function loadTestData() {
            const status = document.getElementById('testDataStatus');
            const results = document.getElementById('testDataResults');
            const btn = document.getElementById('loadTestBtn');
            
            status.className = 'status pending';
            status.textContent = 'æ­£åœ¨åŠ è½½æµ‹è¯•æ•°æ®...';
            btn.disabled = true;
            
            try {
                const response = await fetch('test-case-data.json');
                testData = await response.json();
                
                status.className = 'status success';
                status.textContent = 'âœ… æµ‹è¯•æ•°æ®åŠ è½½æˆåŠŸ';
                
                results.textContent = `åŠ è½½çš„æµ‹è¯•ç”¨ä¾‹: ${testData.testName}
æè¿°: ${testData.description}
æœŸæœ›å›¾å±‚æ•°: ${testData.expectedResults.expectedLayerCount}
æœŸæœ›æºç±»å‹: ${testData.expectedResults.expectedSourceTypes.join(', ')}
æœŸæœ›åˆ†è¾¨ç‡: ${testData.expectedResults.expectedResolution.width}x${testData.expectedResults.expectedResolution.height}`;
                
                testResults.dataLoad = true;
                updateOverallStatus();
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = 'âŒ æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥';
                results.textContent = `é”™è¯¯: ${error.message}`;
            }
            
            btn.disabled = false;
        }

        // åŠ è½½ä¸»ç¨‹åº
        function loadMainApp() {
            const status = document.getElementById('mainAppStatus');
            const btn = document.getElementById('loadMainBtn');
            const frame = document.getElementById('testFrame');
            
            status.className = 'status pending';
            status.textContent = 'æ­£åœ¨åŠ è½½ä¸»ç¨‹åº...';
            btn.disabled = true;
            
            frame.onload = function() {
                setTimeout(() => {
                    try {
                        // æ£€æŸ¥iframeæ˜¯å¦æˆåŠŸåŠ è½½
                        const frameDoc = frame.contentDocument || frame.contentWindow.document;
                        if (frameDoc && frameDoc.title) {
                            status.className = 'status success';
                            status.textContent = 'âœ… ä¸»ç¨‹åºåŠ è½½æˆåŠŸ';
                            testResults.appLoad = true;
                            document.getElementById('functionalBtn').disabled = false;
                            updateOverallStatus();
                        } else {
                            throw new Error('æ— æ³•è®¿é—®iframeå†…å®¹');
                        }
                    } catch (error) {
                        status.className = 'status error';
                        status.textContent = 'âŒ ä¸»ç¨‹åºåŠ è½½å¤±è´¥';
                        console.error('App load error:', error);
                    }
                    btn.disabled = false;
                }, 2000);
            };
            
            frame.onerror = function() {
                status.className = 'status error';
                status.textContent = 'âŒ ä¸»ç¨‹åºåŠ è½½å¤±è´¥';
                btn.disabled = false;
            };
            
            frame.src = 'overlay_visualization.html';
        }

        // è¿è¡ŒåŠŸèƒ½æµ‹è¯•
        async function runFunctionalTests() {
            if (!testData) {
                alert('è¯·å…ˆåŠ è½½æµ‹è¯•æ•°æ®');
                return;
            }
            
            const status = document.getElementById('functionalStatus');
            const results = document.getElementById('functionalResults');
            const btn = document.getElementById('functionalBtn');
            
            status.className = 'status pending';
            status.textContent = 'æ­£åœ¨è¿è¡ŒåŠŸèƒ½æµ‹è¯•...';
            btn.disabled = true;
            
            let testLog = 'å¼€å§‹åŠŸèƒ½æµ‹è¯•...\n\n';
            
            try {
                const frame = document.getElementById('testFrame');
                const frameWindow = frame.contentWindow;
                
                // ç­‰å¾…ä¸»ç¨‹åºå®Œå…¨åŠ è½½
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                testLog += '1. æ£€æŸ¥ä¸»ç¨‹åºæ˜¯å¦å·²åŠ è½½...\n';
                if (!frameWindow || !frameWindow.parseConfiguration) {
                    throw new Error('ä¸»ç¨‹åºæœªæ­£ç¡®åŠ è½½æˆ–ç¼ºå°‘å¿…è¦å‡½æ•°');
                }
                testLog += '   âœ… ä¸»ç¨‹åºåŠ è½½æ­£å¸¸\n\n';
                
                testLog += '2. æ³¨å…¥æµ‹è¯•æ•°æ®...\n';
                // è®¾ç½®æµ‹è¯•å›¾ç‰‡
                const gameImage = frameWindow.document.getElementById('gameImage');
                if (gameImage) {
                    // ä½¿ç”¨æä¾›çš„å›¾ç‰‡æˆ–é»˜è®¤å›¾ç‰‡
                    gameImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYwIiBoZWlnaHQ9IjU0MCIgdmlld0JveD0iMCAwIDk2MCA1NDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9Ijk2MCIgaGVpZ2h0PSI1NDAiIGZpbGw9IiNmMGYwZjAiIHN0cm9rZT0iI2RkZCIgc3Ryb2tlLXdpZHRoPSIyIi8+PHRleHQgeD0iNDgwIiB5PSIyNzAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2NjYiIGZvbnQtc2l6ZT0iMjQiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiI+6L+Z6YeM5Lya5bGV56S65qej6KeQ5ZCO55qE6KeE6KeJ5Zu+PC90ZXh0Pjwvc3ZnPg==';
                    testLog += '   âœ… æµ‹è¯•å›¾ç‰‡å·²è®¾ç½®\n';
                } else {
                    testLog += '   âš ï¸ æœªæ‰¾åˆ°å›¾ç‰‡å…ƒç´ \n';
                }
                
                // è®¾ç½®JSONè¾“å…¥
                const jsonInput = frameWindow.document.getElementById('jsonInput');
                if (jsonInput) {
                    jsonInput.value = JSON.stringify(testData.testData, null, 2);
                    testLog += '   âœ… JSONæ•°æ®å·²è¾“å…¥\n';
                } else {
                    throw new Error('æœªæ‰¾åˆ°JSONè¾“å…¥æ¡†');
                }
                testLog += '\n';
                
                testLog += '3. æ‰§è¡Œè§£æ...\n';
                // è§¦å‘è§£æ
                await frameWindow.parseConfiguration();
                
                // ç­‰å¾…è§£æå®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                testLog += '   âœ… è§£æå‡½æ•°å·²æ‰§è¡Œ\n\n';
                
                testLog += '4. éªŒè¯è§£æç»“æœ...\n';
                // æ£€æŸ¥è§£æç»“æœ
                const parsedLayers = frameWindow.parsedLayers;
                if (!parsedLayers || !Array.isArray(parsedLayers)) {
                    throw new Error('è§£æç»“æœä¸æ­£ç¡®');
                }
                
                testLog += `   æœŸæœ›å›¾å±‚æ•°: ${testData.expectedResults.expectedLayerCount}\n`;
                testLog += `   å®é™…å›¾å±‚æ•°: ${parsedLayers.length}\n`;
                
                if (parsedLayers.length === testData.expectedResults.expectedLayerCount) {
                    testLog += '   âœ… å›¾å±‚æ•°é‡æ­£ç¡®\n';
                } else {
                    testLog += '   âš ï¸ å›¾å±‚æ•°é‡ä¸åŒ¹é…\n';
                }
                
                // æ£€æŸ¥åˆ†è¾¨ç‡
                const canvasResolution = frameWindow.canvasResolution;
                testLog += `   æœŸæœ›åˆ†è¾¨ç‡: ${testData.expectedResults.expectedResolution.width}x${testData.expectedResults.expectedResolution.height}\n`;
                testLog += `   å®é™…åˆ†è¾¨ç‡: ${canvasResolution.width}x${canvasResolution.height}\n`;
                
                if (canvasResolution.width === testData.expectedResults.expectedResolution.width &&
                    canvasResolution.height === testData.expectedResults.expectedResolution.height) {
                    testLog += '   âœ… åˆ†è¾¨ç‡æ­£ç¡®\n';
                } else {
                    testLog += '   âš ï¸ åˆ†è¾¨ç‡ä¸åŒ¹é…\n';
                }
                
                // æ£€æŸ¥UIæ›´æ–°
                const layerList = frameWindow.document.getElementById('layerList');
                if (layerList && layerList.children.length > 1) {
                    testLog += '   âœ… å›¾å±‚åˆ—è¡¨å·²æ›´æ–°\n';
                } else {
                    testLog += '   âš ï¸ å›¾å±‚åˆ—è¡¨æœªæ­£ç¡®æ›´æ–°\n';
                }
                
                testLog += '\n5. æµ‹è¯•å®Œæˆ\n';
                testLog += 'âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡\n';
                
                status.className = 'status success';
                status.textContent = 'âœ… åŠŸèƒ½æµ‹è¯•å®Œæˆ';
                testResults.functional = true;
                
            } catch (error) {
                testLog += `\nâŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                status.className = 'status error';
                status.textContent = 'âŒ åŠŸèƒ½æµ‹è¯•å¤±è´¥';
                testResults.functional = false;
            }
            
            results.textContent = testLog;
            btn.disabled = false;
            updateOverallStatus();
        }

        // æ›´æ–°æ€»ä½“çŠ¶æ€
        function updateOverallStatus() {
            const status = document.getElementById('overallStatus');
            const { dataLoad, appLoad, functional } = testResults;
            
            if (dataLoad && appLoad && functional) {
                status.className = 'status success';
                status.textContent = 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ - å¯ä»¥å®‰å…¨å‘å¸ƒ';
                generateTestReport();
            } else if (dataLoad || appLoad || functional) {
                status.className = 'status pending';
                status.textContent = 'â³ æµ‹è¯•è¿›è¡Œä¸­...';
            } else {
                status.className = 'status pending';
                status.textContent = 'ç­‰å¾…å¼€å§‹æµ‹è¯•...';
            }
        }

        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        function generateTestReport() {
            const report = document.getElementById('testReport');
            testResults.endTime = new Date();
            
            const duration = testResults.endTime - testResults.startTime;
            
            report.textContent = `æµ‹è¯•æŠ¥å‘Š - ${new Date().toLocaleString()}
=====================================

æµ‹è¯•ç”¨ä¾‹: ${testData.testName}
æµ‹è¯•è€—æ—¶: ${Math.round(duration / 1000)} ç§’

æµ‹è¯•ç»“æœ:
- æ•°æ®åŠ è½½: ${testResults.dataLoad ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
- ç¨‹åºåŠ è½½: ${testResults.appLoad ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}  
- åŠŸèƒ½éªŒè¯: ${testResults.functional ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}

æ€»ä½“çŠ¶æ€: ${testResults.dataLoad && testResults.appLoad && testResults.functional ? 'âœ… æµ‹è¯•é€šè¿‡ - å¯ä»¥å‘å¸ƒ' : 'âŒ æµ‹è¯•å¤±è´¥ - éœ€è¦ä¿®å¤'}

å»ºè®®: ${testResults.dataLoad && testResults.appLoad && testResults.functional ? 
'æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ŒåŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥å®‰å…¨å‘å¸ƒåˆ°gitã€‚' : 
'å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•é¡¹å¹¶ä¿®å¤åé‡æ–°æµ‹è¯•ã€‚'}`;
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            testResults.startTime = new Date();
            
            await loadTestData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            loadMainApp();
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            if (testResults.appLoad) {
                await runFunctionalTests();
            }
        }

        // å¿«é€Ÿæµ‹è¯•
        async function runQuickTest() {
            testResults.startTime = new Date();
            
            // åªæµ‹è¯•æ ¸å¿ƒè§£æåŠŸèƒ½
            await loadTestData();
            if (testResults.dataLoad) {
                alert('å¿«é€Ÿæµ‹è¯•ï¼šæ•°æ®åŠ è½½æ­£å¸¸ï¼Œå»ºè®®è¿è¡Œå®Œæ•´æµ‹è¯•éªŒè¯UIåŠŸèƒ½');
            }
        }
    </script>
</body>
</html> 