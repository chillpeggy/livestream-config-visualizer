<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONè§£æå…¼å®¹æ€§æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        textarea { width: 100%; height: 120px; font-family: monospace; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-summary { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        h3 { margin-top: 0; color: #333; }
        .log { font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto; background: #f1f3f4; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª JSONè§£æå…¼å®¹æ€§æµ‹è¯•</h1>
    
    <div class="test-summary">
        <h3>æµ‹è¯•æ¦‚è¿°</h3>
        <p>æ­¤æµ‹è¯•éªŒè¯æ–°çš„å®¹é”™è§£æåŠŸèƒ½æ˜¯å¦ä¸ä¹‹å‰çš„æ­£å¸¸æ ¼å¼å…¼å®¹ï¼Œç¡®ä¿ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½ã€‚</p>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <div id="overallResult"></div>
    </div>

    <div class="test-grid">
        <div class="test-case">
            <h3>âœ… æµ‹è¯•1: æ­£ç¡®æ ¼å¼ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰</h3>
            <p>æµ‹è¯•ä¹‹å‰å°±èƒ½æ­£å¸¸å·¥ä½œçš„æ­£ç¡®JSONæ ¼å¼</p>
            <textarea id="correctFormat">{"resolution":"{\"width\":1440,\"height\":1080}","sourceInfo":"{\"camera\":{\"sourceList\":[{\"name\":\"æ‘„åƒå¤´\",\"layer\":1}]}}","obsSourceInfo":"{\"camera\":[{\"name\":\"Logitech c1000e\"}],\"image\":[{\"name\":\"èƒŒæ™¯å›¾ç‰‡\"}]}","hackInfo":"{}","pcSpeakerDecibel":-40.88}</textarea>
            <button onclick="testFormat('correctFormat', 'æ­£ç¡®æ ¼å¼')">æµ‹è¯•æ­£ç¡®æ ¼å¼</button>
            <div id="correctFormatResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>ğŸ”§ æµ‹è¯•2: è½¬ä¹‰é”™è¯¯æ ¼å¼ï¼ˆæ–°åŠŸèƒ½ï¼‰</h3>
            <p>æµ‹è¯•éœ€è¦è‡ªåŠ¨ä¿®å¤çš„æ ¼å¼ï¼ˆç”¨æˆ·æä¾›çš„é—®é¢˜æ ¼å¼ï¼‰</p>
            <textarea id="brokenFormat">{"resolution":"{"width":1440,"height":1080}","sourceInfo":"{"camera":{"sourceList":[{"name":"æ‘„åƒå¤´","layer":1}]}}","obsSourceInfo":"{"camera":[{"name":"Logitech c1000e"}],"image":[{"name":"èƒŒæ™¯å›¾ç‰‡"}]}","hackInfo":"{}","pcSpeakerDecibel":-40.88}</textarea>
            <button onclick="testFormat('brokenFormat', 'è½¬ä¹‰é”™è¯¯æ ¼å¼')">æµ‹è¯•é”™è¯¯æ ¼å¼</button>
            <div id="brokenFormatResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>ğŸ¯ æµ‹è¯•3: å¤æ‚æ­£ç¡®æ ¼å¼</h3>
            <p>æµ‹è¯•åŒ…å«æ›´å¤šå­—æ®µçš„æ­£ç¡®æ ¼å¼</p>
            <textarea id="complexCorrectFormat">{"anglogSourceOverlap":0,"cameraSourceOverlap":1,"hackInfo":"{}","micDecible":-19.29,"micDecibleList":"[-45.73,-38.71,-25.15]","obsSourceInfo":"{\"auxAudioVolumn\":0.98,\"camera\":[{\"deviceId\":\"VS009M1\",\"name\":\"è§†é¢‘é‡‡é›†è®¾å¤‡\"}],\"image\":[{\"name\":\"èµ¤ä¸¥\",\"filepath\":\"E:/test.png\"}]}","pcSpeakerDecibel":-40.88,"resolution":"{\"height\":1080,\"width\":1440}","sourceInfo":"{\"camera\":{\"sourceList\":[{\"name\":\"Logitech c1000e\",\"layer\":0}]}}","timestamp":1751442583}</textarea>
            <button onclick="testFormat('complexCorrectFormat', 'å¤æ‚æ­£ç¡®æ ¼å¼')">æµ‹è¯•å¤æ‚æ ¼å¼</button>
            <div id="complexCorrectFormatResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>âš¡ æµ‹è¯•4: å¤æ‚é”™è¯¯æ ¼å¼</h3>
            <p>æµ‹è¯•ç”¨æˆ·å®é™…æä¾›çš„å¤æ‚é”™è¯¯æ ¼å¼</p>
            <textarea id="complexBrokenFormat">{"anglogSourceOverlap":0,"cameraSourceOverlap":1,"hackInfo":"{}","micDecible":-19.29,"micDecibleList":"[-45.73,-38.71,-25.15]","obsSourceInfo":"{"auxAudioVolumn":0.98,"camera":[{"deviceId":"VS009M1","name":"è§†é¢‘é‡‡é›†è®¾å¤‡"}],"image":[{"name":"èµ¤ä¸¥","filepath":"E:/test.png"}]}","pcSpeakerDecibel":-40.88,"resolution":"{"height":1080,"width":1440}","sourceInfo":"{"camera":{"sourceList":[{"name":"Logitech c1000e","layer":0}]}}","timestamp":1751442583}</textarea>
            <button onclick="testFormat('complexBrokenFormat', 'å¤æ‚é”™è¯¯æ ¼å¼')">æµ‹è¯•å¤æ‚é”™è¯¯æ ¼å¼</button>
            <div id="complexBrokenFormatResult" class="result"></div>
        </div>
    </div>

    <div class="test-case">
        <h3>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        let testResults = [];
        let testLog = [];

        function log(message) {
            testLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('testLog').innerHTML = testLog.join('\n');
            console.log(message);
        }

        // å¤åˆ¶ä¸»è¦çš„ä¿®å¤å‡½æ•°
        function fixNestedJsonEscaping(jsonStr) {
            log('ğŸ”§ å¼€å§‹ä¿®å¤åµŒå¥—JSONè½¬ä¹‰é—®é¢˜...');
            
            const nestedJsonFields = ['obsSourceInfo', 'sourceInfo', 'resolution', 'hackInfo'];
            let fixed = jsonStr;
            
            nestedJsonFields.forEach(fieldName => {
                const fieldPattern = new RegExp(`"${fieldName}"\\s*:\\s*"\\{`, 'g');
                
                if (fieldPattern.test(fixed)) {
                    log(`ğŸ”§ æ£€æµ‹åˆ°${fieldName}å­—æ®µéœ€è¦ä¿®å¤è½¬ä¹‰`);
                    fieldPattern.lastIndex = 0;
                    
                    const fieldMatch = fieldPattern.exec(fixed);
                    if (fieldMatch) {
                        const valueStart = fieldMatch.index + fieldMatch[0].length - 1;
                        
                        let braceCount = 0;
                        let inString = false;
                        let escapeNext = false;
                        let valueEnd = -1;
                        
                        for (let i = valueStart; i < fixed.length; i++) {
                            const char = fixed[i];
                            
                            if (escapeNext) {
                                escapeNext = false;
                                continue;
                            }
                            
                            if (char === '\\') {
                                escapeNext = true;
                                continue;
                            }
                            
                            if (char === '"' && !escapeNext) {
                                inString = !inString;
                                continue;
                            }
                            
                            if (!inString) {
                                if (char === '{') {
                                    braceCount++;
                                } else if (char === '}') {
                                    braceCount--;
                                    if (braceCount === 0) {
                                        for (let j = i + 1; j < fixed.length; j++) {
                                            if (fixed[j] === '"') {
                                                valueEnd = j;
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (valueEnd > valueStart) {
                            const nestedJsonStr = fixed.substring(valueStart, valueEnd);
                            const fixedNestedJson = nestedJsonStr.replace(/"/g, '\\"');
                            
                            const before = fixed.substring(0, valueStart);
                            const after = fixed.substring(valueEnd);
                            fixed = before + fixedNestedJson + after;
                            
                            log(`âœ… ${fieldName}å­—æ®µè½¬ä¹‰ä¿®å¤å®Œæˆ`);
                        }
                    }
                }
            });
            
            return fixed;
        }

        function parseNestedJsonField(jsonStr, fieldName) {
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                log(`ğŸ”§ ${fieldName}ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤è½¬ä¹‰: ${e.message}`);
                
                try {
                    let fixed = jsonStr;
                    if (!fixed.startsWith('{') && fixed.includes('{')) {
                        if (fixed.match(/^"?\{/)) {
                            fixed = fixed.replace(/^"/, '');
                            fixed = fixed.replace(/"$/, '');
                        }
                    }
                    
                    const result = JSON.parse(fixed);
                    log(`âœ… ${fieldName}ä¿®å¤åè§£ææˆåŠŸ`);
                    return result;
                } catch (e2) {
                    throw e2;
                }
            }
        }

        function testFormat(textareaId, formatName) {
            const configText = document.getElementById(textareaId).value;
            const resultDiv = document.getElementById(textareaId + 'Result');
            
            log(`\nğŸ§ª å¼€å§‹æµ‹è¯•: ${formatName}`);
            
            try {
                let data;
                let parseMethod = '';
                
                // å…ˆå°è¯•ç›´æ¥è§£æ
                try {
                    data = JSON.parse(configText);
                    parseMethod = 'ç›´æ¥è§£ææˆåŠŸ';
                    log(`âœ… ${formatName}: ç›´æ¥JSONè§£ææˆåŠŸ`);
                } catch (e) {
                    log(`âš ï¸ ${formatName}: ç›´æ¥è§£æå¤±è´¥: ${e.message}`);
                    
                    // ä½¿ç”¨ä¿®å¤å‡½æ•°
                    const fixedConfig = fixNestedJsonEscaping(configText);
                    data = JSON.parse(fixedConfig);
                    parseMethod = 'ä¿®å¤åè§£ææˆåŠŸ';
                    log(`âœ… ${formatName}: ä¿®å¤åè§£ææˆåŠŸ`);
                }
                
                // æµ‹è¯•åµŒå¥—å­—æ®µè§£æ
                const tests = [];
                
                if (data.obsSourceInfo) {
                    try {
                        const obsData = parseNestedJsonField(data.obsSourceInfo, 'obsSourceInfo');
                        tests.push(`obsSourceInfo: ${Object.keys(obsData).length}ä¸ªæºç±»å‹`);
                        log(`âœ… obsSourceInfoè§£ææˆåŠŸ: ${Object.keys(obsData)}`);
                    } catch (e) {
                        tests.push(`obsSourceInfo: è§£æå¤±è´¥ - ${e.message}`);
                        log(`âŒ obsSourceInfoè§£æå¤±è´¥: ${e.message}`);
                    }
                }
                
                if (data.sourceInfo) {
                    try {
                        const sourceData = parseNestedJsonField(data.sourceInfo, 'sourceInfo');
                        tests.push(`sourceInfo: ${Object.keys(sourceData).length}ä¸ªæºç±»å‹`);
                        log(`âœ… sourceInfoè§£ææˆåŠŸ: ${Object.keys(sourceData)}`);
                    } catch (e) {
                        tests.push(`sourceInfo: è§£æå¤±è´¥ - ${e.message}`);
                        log(`âŒ sourceInfoè§£æå¤±è´¥: ${e.message}`);
                    }
                }
                
                if (data.resolution) {
                    try {
                        const resolutionData = parseNestedJsonField(data.resolution, 'resolution');
                        tests.push(`resolution: ${resolutionData.width}x${resolutionData.height}`);
                        log(`âœ… resolutionè§£ææˆåŠŸ: ${resolutionData.width}x${resolutionData.height}`);
                    } catch (e) {
                        tests.push(`resolution: è§£æå¤±è´¥ - ${e.message}`);
                        log(`âŒ resolutionè§£æå¤±è´¥: ${e.message}`);
                    }
                }
                
                resultDiv.innerHTML = `
                    <h4>âœ… ${formatName} - æµ‹è¯•æˆåŠŸ</h4>
                    <p><strong>è§£ææ–¹æ³•:</strong> ${parseMethod}</p>
                    <p><strong>ä¸»å­—æ®µæ•°é‡:</strong> ${Object.keys(data).length}</p>
                    <p><strong>åµŒå¥—å­—æ®µæµ‹è¯•:</strong></p>
                    <ul>${tests.map(test => `<li>${test}</li>`).join('')}</ul>
                `;
                resultDiv.className = 'result success';
                
                testResults.push({name: formatName, success: true, method: parseMethod});
                log(`ğŸ‰ ${formatName} æµ‹è¯•å®Œæˆ - æˆåŠŸ`);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>âŒ ${formatName} - æµ‹è¯•å¤±è´¥</h4>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
                resultDiv.className = 'result error';
                
                testResults.push({name: formatName, success: false, error: error.message});
                log(`ğŸ’¥ ${formatName} æµ‹è¯•å®Œæˆ - å¤±è´¥: ${error.message}`);
            }
            
            updateOverallResult();
        }

        function runAllTests() {
            log('\nğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰å…¼å®¹æ€§æµ‹è¯•...');
            testResults = [];
            
            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            testFormat('correctFormat', 'æ­£ç¡®æ ¼å¼');
            setTimeout(() => testFormat('brokenFormat', 'è½¬ä¹‰é”™è¯¯æ ¼å¼'), 100);
            setTimeout(() => testFormat('complexCorrectFormat', 'å¤æ‚æ­£ç¡®æ ¼å¼'), 200);
            setTimeout(() => testFormat('complexBrokenFormat', 'å¤æ‚é”™è¯¯æ ¼å¼'), 300);
        }

        function updateOverallResult() {
            const overallDiv = document.getElementById('overallResult');
            
            if (testResults.length === 0) {
                overallDiv.innerHTML = '';
                return;
            }
            
            const successCount = testResults.filter(r => r.success).length;
            const totalCount = testResults.length;
            
            if (successCount === totalCount) {
                overallDiv.innerHTML = `
                    <div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼(${successCount}/${totalCount}) - æ–°åŠŸèƒ½ä¸åŸæœ‰åŠŸèƒ½å®Œå…¨å…¼å®¹
                    </div>
                `;
            } else {
                overallDiv.innerHTML = `
                    <div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        âš ï¸ ${totalCount - successCount}ä¸ªæµ‹è¯•å¤±è´¥ (${successCount}/${totalCount})
                    </div>
                `;
            }
        }

        // åˆå§‹åŒ–
        log('ğŸ“‹ å…¼å®¹æ€§æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
    </script>
</body>
</html> 