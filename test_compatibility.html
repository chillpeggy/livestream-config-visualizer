<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON解析兼容性测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        textarea { width: 100%; height: 120px; font-family: monospace; font-size: 12px; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-summary { background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        h3 { margin-top: 0; color: #333; }
        .log { font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto; background: #f1f3f4; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>🧪 JSON解析兼容性测试</h1>
    
    <div class="test-summary">
        <h3>测试概述</h3>
        <p>此测试验证新的容错解析功能是否与之前的正常格式兼容，确保不会影响现有功能。</p>
        <button onclick="runAllTests()">🚀 运行所有测试</button>
        <div id="overallResult"></div>
    </div>

    <div class="test-grid">
        <div class="test-case">
            <h3>✅ 测试1: 正确格式（原有功能）</h3>
            <p>测试之前就能正常工作的正确JSON格式</p>
            <textarea id="correctFormat">{"resolution":"{\"width\":1440,\"height\":1080}","sourceInfo":"{\"camera\":{\"sourceList\":[{\"name\":\"摄像头\",\"layer\":1}]}}","obsSourceInfo":"{\"camera\":[{\"name\":\"Logitech c1000e\"}],\"image\":[{\"name\":\"背景图片\"}]}","hackInfo":"{}","pcSpeakerDecibel":-40.88}</textarea>
            <button onclick="testFormat('correctFormat', '正确格式')">测试正确格式</button>
            <div id="correctFormatResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>🔧 测试2: 转义错误格式（新功能）</h3>
            <p>测试需要自动修复的格式（用户提供的问题格式）</p>
            <textarea id="brokenFormat">{"resolution":"{"width":1440,"height":1080}","sourceInfo":"{"camera":{"sourceList":[{"name":"摄像头","layer":1}]}}","obsSourceInfo":"{"camera":[{"name":"Logitech c1000e"}],"image":[{"name":"背景图片"}]}","hackInfo":"{}","pcSpeakerDecibel":-40.88}</textarea>
            <button onclick="testFormat('brokenFormat', '转义错误格式')">测试错误格式</button>
            <div id="brokenFormatResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>🎯 测试3: 复杂正确格式</h3>
            <p>测试包含更多字段的正确格式</p>
            <textarea id="complexCorrectFormat">{"anglogSourceOverlap":0,"cameraSourceOverlap":1,"hackInfo":"{}","micDecible":-19.29,"micDecibleList":"[-45.73,-38.71,-25.15]","obsSourceInfo":"{\"auxAudioVolumn\":0.98,\"camera\":[{\"deviceId\":\"VS009M1\",\"name\":\"视频采集设备\"}],\"image\":[{\"name\":\"赤严\",\"filepath\":\"E:/test.png\"}]}","pcSpeakerDecibel":-40.88,"resolution":"{\"height\":1080,\"width\":1440}","sourceInfo":"{\"camera\":{\"sourceList\":[{\"name\":\"Logitech c1000e\",\"layer\":0}]}}","timestamp":1751442583}</textarea>
            <button onclick="testFormat('complexCorrectFormat', '复杂正确格式')">测试复杂格式</button>
            <div id="complexCorrectFormatResult" class="result"></div>
        </div>

        <div class="test-case">
            <h3>⚡ 测试4: 复杂错误格式</h3>
            <p>测试用户实际提供的复杂错误格式</p>
            <textarea id="complexBrokenFormat">{"anglogSourceOverlap":0,"cameraSourceOverlap":1,"hackInfo":"{}","micDecible":-19.29,"micDecibleList":"[-45.73,-38.71,-25.15]","obsSourceInfo":"{"auxAudioVolumn":0.98,"camera":[{"deviceId":"VS009M1","name":"视频采集设备"}],"image":[{"name":"赤严","filepath":"E:/test.png"}]}","pcSpeakerDecibel":-40.88,"resolution":"{"height":1080,"width":1440}","sourceInfo":"{"camera":{"sourceList":[{"name":"Logitech c1000e","layer":0}]}}","timestamp":1751442583}</textarea>
            <button onclick="testFormat('complexBrokenFormat', '复杂错误格式')">测试复杂错误格式</button>
            <div id="complexBrokenFormatResult" class="result"></div>
        </div>
    </div>

    <div class="test-case">
        <h3>📋 测试日志</h3>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        let testResults = [];
        let testLog = [];

        function log(message) {
            testLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('testLog').innerHTML = testLog.join('\n');
            console.log(message);
        }

        // 复制主要的修复函数
        function fixNestedJsonEscaping(jsonStr) {
            log('🔧 开始修复嵌套JSON转义问题...');
            
            const nestedJsonFields = ['obsSourceInfo', 'sourceInfo', 'resolution', 'hackInfo'];
            let fixed = jsonStr;
            
            nestedJsonFields.forEach(fieldName => {
                const fieldPattern = new RegExp(`"${fieldName}"\\s*:\\s*"\\{`, 'g');
                
                if (fieldPattern.test(fixed)) {
                    log(`🔧 检测到${fieldName}字段需要修复转义`);
                    fieldPattern.lastIndex = 0;
                    
                    const fieldMatch = fieldPattern.exec(fixed);
                    if (fieldMatch) {
                        const valueStart = fieldMatch.index + fieldMatch[0].length - 1;
                        
                        let braceCount = 0;
                        let inString = false;
                        let escapeNext = false;
                        let valueEnd = -1;
                        
                        for (let i = valueStart; i < fixed.length; i++) {
                            const char = fixed[i];
                            
                            if (escapeNext) {
                                escapeNext = false;
                                continue;
                            }
                            
                            if (char === '\\') {
                                escapeNext = true;
                                continue;
                            }
                            
                            if (char === '"' && !escapeNext) {
                                inString = !inString;
                                continue;
                            }
                            
                            if (!inString) {
                                if (char === '{') {
                                    braceCount++;
                                } else if (char === '}') {
                                    braceCount--;
                                    if (braceCount === 0) {
                                        for (let j = i + 1; j < fixed.length; j++) {
                                            if (fixed[j] === '"') {
                                                valueEnd = j;
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (valueEnd > valueStart) {
                            const nestedJsonStr = fixed.substring(valueStart, valueEnd);
                            const fixedNestedJson = nestedJsonStr.replace(/"/g, '\\"');
                            
                            const before = fixed.substring(0, valueStart);
                            const after = fixed.substring(valueEnd);
                            fixed = before + fixedNestedJson + after;
                            
                            log(`✅ ${fieldName}字段转义修复完成`);
                        }
                    }
                }
            });
            
            return fixed;
        }

        function parseNestedJsonField(jsonStr, fieldName) {
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                log(`🔧 ${fieldName}直接解析失败，尝试修复转义: ${e.message}`);
                
                try {
                    let fixed = jsonStr;
                    if (!fixed.startsWith('{') && fixed.includes('{')) {
                        if (fixed.match(/^"?\{/)) {
                            fixed = fixed.replace(/^"/, '');
                            fixed = fixed.replace(/"$/, '');
                        }
                    }
                    
                    const result = JSON.parse(fixed);
                    log(`✅ ${fieldName}修复后解析成功`);
                    return result;
                } catch (e2) {
                    throw e2;
                }
            }
        }

        function testFormat(textareaId, formatName) {
            const configText = document.getElementById(textareaId).value;
            const resultDiv = document.getElementById(textareaId + 'Result');
            
            log(`\n🧪 开始测试: ${formatName}`);
            
            try {
                let data;
                let parseMethod = '';
                
                // 先尝试直接解析
                try {
                    data = JSON.parse(configText);
                    parseMethod = '直接解析成功';
                    log(`✅ ${formatName}: 直接JSON解析成功`);
                } catch (e) {
                    log(`⚠️ ${formatName}: 直接解析失败: ${e.message}`);
                    
                    // 使用修复函数
                    const fixedConfig = fixNestedJsonEscaping(configText);
                    data = JSON.parse(fixedConfig);
                    parseMethod = '修复后解析成功';
                    log(`✅ ${formatName}: 修复后解析成功`);
                }
                
                // 测试嵌套字段解析
                const tests = [];
                
                if (data.obsSourceInfo) {
                    try {
                        const obsData = parseNestedJsonField(data.obsSourceInfo, 'obsSourceInfo');
                        tests.push(`obsSourceInfo: ${Object.keys(obsData).length}个源类型`);
                        log(`✅ obsSourceInfo解析成功: ${Object.keys(obsData)}`);
                    } catch (e) {
                        tests.push(`obsSourceInfo: 解析失败 - ${e.message}`);
                        log(`❌ obsSourceInfo解析失败: ${e.message}`);
                    }
                }
                
                if (data.sourceInfo) {
                    try {
                        const sourceData = parseNestedJsonField(data.sourceInfo, 'sourceInfo');
                        tests.push(`sourceInfo: ${Object.keys(sourceData).length}个源类型`);
                        log(`✅ sourceInfo解析成功: ${Object.keys(sourceData)}`);
                    } catch (e) {
                        tests.push(`sourceInfo: 解析失败 - ${e.message}`);
                        log(`❌ sourceInfo解析失败: ${e.message}`);
                    }
                }
                
                if (data.resolution) {
                    try {
                        const resolutionData = parseNestedJsonField(data.resolution, 'resolution');
                        tests.push(`resolution: ${resolutionData.width}x${resolutionData.height}`);
                        log(`✅ resolution解析成功: ${resolutionData.width}x${resolutionData.height}`);
                    } catch (e) {
                        tests.push(`resolution: 解析失败 - ${e.message}`);
                        log(`❌ resolution解析失败: ${e.message}`);
                    }
                }
                
                resultDiv.innerHTML = `
                    <h4>✅ ${formatName} - 测试成功</h4>
                    <p><strong>解析方法:</strong> ${parseMethod}</p>
                    <p><strong>主字段数量:</strong> ${Object.keys(data).length}</p>
                    <p><strong>嵌套字段测试:</strong></p>
                    <ul>${tests.map(test => `<li>${test}</li>`).join('')}</ul>
                `;
                resultDiv.className = 'result success';
                
                testResults.push({name: formatName, success: true, method: parseMethod});
                log(`🎉 ${formatName} 测试完成 - 成功`);
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>❌ ${formatName} - 测试失败</h4>
                    <p><strong>错误:</strong> ${error.message}</p>
                `;
                resultDiv.className = 'result error';
                
                testResults.push({name: formatName, success: false, error: error.message});
                log(`💥 ${formatName} 测试完成 - 失败: ${error.message}`);
            }
            
            updateOverallResult();
        }

        function runAllTests() {
            log('\n🚀 开始运行所有兼容性测试...');
            testResults = [];
            
            // 依次运行所有测试
            testFormat('correctFormat', '正确格式');
            setTimeout(() => testFormat('brokenFormat', '转义错误格式'), 100);
            setTimeout(() => testFormat('complexCorrectFormat', '复杂正确格式'), 200);
            setTimeout(() => testFormat('complexBrokenFormat', '复杂错误格式'), 300);
        }

        function updateOverallResult() {
            const overallDiv = document.getElementById('overallResult');
            
            if (testResults.length === 0) {
                overallDiv.innerHTML = '';
                return;
            }
            
            const successCount = testResults.filter(r => r.success).length;
            const totalCount = testResults.length;
            
            if (successCount === totalCount) {
                overallDiv.innerHTML = `
                    <div style="color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        🎉 所有测试通过！(${successCount}/${totalCount}) - 新功能与原有功能完全兼容
                    </div>
                `;
            } else {
                overallDiv.innerHTML = `
                    <div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        ⚠️ ${totalCount - successCount}个测试失败 (${successCount}/${totalCount})
                    </div>
                `;
            }
        }

        // 初始化
        log('📋 兼容性测试页面加载完成');
    </script>
</body>
</html> 