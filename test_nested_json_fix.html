<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嵌套JSON转义修复测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        textarea { width: 100%; height: 150px; font-family: monospace; }
        button { padding: 10px 20px; margin: 10px 0; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>嵌套JSON转义修复功能测试</h1>
    
    <div class="test-case">
        <h3>测试用例：用户提供的配置（转义不正确）</h3>
        <textarea id="userConfig">{"anglogSourceOverlap":0,"cameraSourceOverlap":1,"hackInfo":"{}","hangupVersion":10,"isMirroring":false,"isVirtualIdol":false,"liveMode":0,"micDecible":-19.29,"micDecibleList":"[-45.73,-38.71,-25.15,-10.03,-15.95,-34.95,-18.12,-22.6,-48.63,-18.22,-6.09,-16.33,-24.19,-19.79,-24.25,-16.27,-7.38,-17.22,-12.84,-35.35,-11.19,-17.92,-7.67,-42.76,-14.82,-22.61,-21.2,-27.12,-17.67,-19.29]","obsSourceInfo":"{"auxAudioVolumn":0.98,"camera":[{"deviceId":"VS009M1","isSoftware":false,"name":"视频采集设备","pos":{"x":0,"y":0},"realDeviceId":"\\\\\\\\?\\\\usb#22vid_048d\\u0026pid_9325\\u0026mi_00#226\\u002630d34b43\\u00260\\u00260000#22{65e8773d-8f56-11d0-a3b9-00a0c9223196}\\\\global","volume":1}],"desktopAudioVolumn":0.64,"image":[{"fileSize":30128,"filepath":"E:/直播使用照片/烽火/11.png","name":"赤严","pos":{"x":779,"y":337}}],"video":[{"fileSize":7408994,"filepath":"E:/直播使用照片/烽火/1.mp4","looping":true,"name":"倒计时","pos":{"x":0,"y":0},"volume":1}],"window":[{"exeName":":CHWindow:Airplayer苹果录屏大师.exe","name":"手机","pos":{"x":1,"y":0}}]}","pcSpeakerDecibel":-40.88,"resolution":"{"height":1080,"width":1440}","sourceInfo":"{"camera":{"sourceList":[{"canvasOverlap":1,"canvasOverlapRect":[0,0,1440,1080],"deviceId":"Logitech c1000e","isSoftware":true,"layer":0,"name":"Logitech c1000e","opacity":-1,"overlap":1}],"totalOverlap":1}}","timestamp":1751442583,"vcamInfo":"[]","videoSourcesOverlap":0}</textarea>
        <button onclick="testUserConfig()">测试用户配置</button>
        <div id="userResult" class="result"></div>
    </div>

    <script>
        // 复制修复函数
        function fixNestedJsonEscaping(jsonStr) {
            console.log('🔧 开始修复嵌套JSON转义问题...');
            
            const nestedJsonFields = ['obsSourceInfo', 'sourceInfo', 'resolution', 'hackInfo'];
            let fixed = jsonStr;
            
            nestedJsonFields.forEach(fieldName => {
                const fieldPattern = new RegExp(`"${fieldName}"\\s*:\\s*"\\{`, 'g');
                
                if (fieldPattern.test(fixed)) {
                    console.log(`🔧 检测到${fieldName}字段需要修复转义`);
                    fieldPattern.lastIndex = 0;
                    
                    const fieldMatch = fieldPattern.exec(fixed);
                    if (fieldMatch) {
                        const valueStart = fieldMatch.index + fieldMatch[0].length - 1;
                        
                        let braceCount = 0;
                        let inString = false;
                        let escapeNext = false;
                        let valueEnd = -1;
                        
                        for (let i = valueStart; i < fixed.length; i++) {
                            const char = fixed[i];
                            
                            if (escapeNext) {
                                escapeNext = false;
                                continue;
                            }
                            
                            if (char === '\\') {
                                escapeNext = true;
                                continue;
                            }
                            
                            if (char === '"' && !escapeNext) {
                                inString = !inString;
                                continue;
                            }
                            
                            if (!inString) {
                                if (char === '{') {
                                    braceCount++;
                                } else if (char === '}') {
                                    braceCount--;
                                    if (braceCount === 0) {
                                        for (let j = i + 1; j < fixed.length; j++) {
                                            if (fixed[j] === '"') {
                                                valueEnd = j;
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (valueEnd > valueStart) {
                            const nestedJsonStr = fixed.substring(valueStart, valueEnd);
                            const fixedNestedJson = nestedJsonStr.replace(/"/g, '\\"');
                            
                            const before = fixed.substring(0, valueStart);
                            const after = fixed.substring(valueEnd);
                            fixed = before + fixedNestedJson + after;
                            
                            console.log(`✅ ${fieldName}字段转义修复完成`);
                        }
                    }
                }
            });
            
            return fixed;
        }

        function parseNestedJsonField(jsonStr, fieldName) {
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                console.log(`🔧 ${fieldName}直接解析失败，尝试修复转义:`, e.message);
                
                try {
                    let fixed = jsonStr;
                    if (!fixed.startsWith('{') && fixed.includes('{')) {
                        if (fixed.match(/^"?\{/)) {
                            fixed = fixed.replace(/^"/, '');
                            fixed = fixed.replace(/"$/, '');
                        }
                    }
                    
                    const result = JSON.parse(fixed);
                    console.log(`✅ ${fieldName}修复后解析成功`);
                    return result;
                } catch (e2) {
                    throw e2;
                }
            }
        }

        function testUserConfig() {
            const userConfig = document.getElementById('userConfig').value;
            const resultDiv = document.getElementById('userResult');
            
            try {
                console.log('🔍 开始测试用户配置...');
                
                // 先尝试直接解析
                try {
                    const directParse = JSON.parse(userConfig);
                    resultDiv.innerHTML = '<h4>❌ 测试失败：直接解析不应该成功</h4>';
                    resultDiv.className = 'result error';
                    return;
                } catch (e) {
                    console.log('✅ 直接解析失败（符合预期）:', e.message);
                }
                
                // 使用修复函数
                const fixedConfig = fixNestedJsonEscaping(userConfig);
                console.log('🔧 修复后的配置长度:', fixedConfig.length);
                
                // 尝试解析修复后的配置
                const parsedData = JSON.parse(fixedConfig);
                console.log('✅ 修复后解析成功');
                
                // 测试嵌套字段
                const obsSourceInfo = parseNestedJsonField(parsedData.obsSourceInfo, 'obsSourceInfo');
                const sourceInfo = parseNestedJsonField(parsedData.sourceInfo, 'sourceInfo');
                const resolution = parseNestedJsonField(parsedData.resolution, 'resolution');
                
                resultDiv.innerHTML = `
                    <h4>✅ 测试成功！</h4>
                    <p><strong>主JSON解析:</strong> 成功</p>
                    <p><strong>obsSourceInfo字段:</strong> ${Object.keys(obsSourceInfo).length}个源类型</p>
                    <p><strong>sourceInfo字段:</strong> ${Object.keys(sourceInfo).length}个源类型</p>
                    <p><strong>resolution字段:</strong> ${resolution.width}x${resolution.height}</p>
                    <p><strong>obsSourceInfo中的源类型:</strong> ${Object.keys(obsSourceInfo).join(', ')}</p>
                    <p><strong>图片源数量:</strong> ${obsSourceInfo.image ? obsSourceInfo.image.length : 0}</p>
                    <p><strong>视频源数量:</strong> ${obsSourceInfo.video ? obsSourceInfo.video.length : 0}</p>
                    <p><strong>摄像头源数量:</strong> ${obsSourceInfo.camera ? obsSourceInfo.camera.length : 0}</p>
                    <p><strong>窗口源数量:</strong> ${obsSourceInfo.window ? obsSourceInfo.window.length : 0}</p>
                `;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>❌ 测试失败</h4>
                    <p><strong>错误:</strong> ${error.message}</p>
                `;
                resultDiv.className = 'result error';
                console.error('测试失败:', error);
            }
        }
    </script>
</body>
</html> 