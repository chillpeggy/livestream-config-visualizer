<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åµŒå¥—JSONè½¬ä¹‰ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        textarea { width: 100%; height: 150px; font-family: monospace; }
        button { padding: 10px 20px; margin: 10px 0; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>åµŒå¥—JSONè½¬ä¹‰ä¿®å¤åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹ï¼šç”¨æˆ·æä¾›çš„é…ç½®ï¼ˆè½¬ä¹‰ä¸æ­£ç¡®ï¼‰</h3>
        <textarea id="userConfig">{"anglogSourceOverlap":0,"cameraSourceOverlap":1,"hackInfo":"{}","hangupVersion":10,"isMirroring":false,"isVirtualIdol":false,"liveMode":0,"micDecible":-19.29,"micDecibleList":"[-45.73,-38.71,-25.15,-10.03,-15.95,-34.95,-18.12,-22.6,-48.63,-18.22,-6.09,-16.33,-24.19,-19.79,-24.25,-16.27,-7.38,-17.22,-12.84,-35.35,-11.19,-17.92,-7.67,-42.76,-14.82,-22.61,-21.2,-27.12,-17.67,-19.29]","obsSourceInfo":"{"auxAudioVolumn":0.98,"camera":[{"deviceId":"VS009M1","isSoftware":false,"name":"è§†é¢‘é‡‡é›†è®¾å¤‡","pos":{"x":0,"y":0},"realDeviceId":"\\\\\\\\?\\\\usb#22vid_048d\\u0026pid_9325\\u0026mi_00#226\\u002630d34b43\\u00260\\u00260000#22{65e8773d-8f56-11d0-a3b9-00a0c9223196}\\\\global","volume":1}],"desktopAudioVolumn":0.64,"image":[{"fileSize":30128,"filepath":"E:/ç›´æ’­ä½¿ç”¨ç…§ç‰‡/çƒ½ç«/11.png","name":"èµ¤ä¸¥","pos":{"x":779,"y":337}}],"video":[{"fileSize":7408994,"filepath":"E:/ç›´æ’­ä½¿ç”¨ç…§ç‰‡/çƒ½ç«/1.mp4","looping":true,"name":"å€’è®¡æ—¶","pos":{"x":0,"y":0},"volume":1}],"window":[{"exeName":":CHWindow:Airplayerè‹¹æœå½•å±å¤§å¸ˆ.exe","name":"æ‰‹æœº","pos":{"x":1,"y":0}}]}","pcSpeakerDecibel":-40.88,"resolution":"{"height":1080,"width":1440}","sourceInfo":"{"camera":{"sourceList":[{"canvasOverlap":1,"canvasOverlapRect":[0,0,1440,1080],"deviceId":"Logitech c1000e","isSoftware":true,"layer":0,"name":"Logitech c1000e","opacity":-1,"overlap":1}],"totalOverlap":1}}","timestamp":1751442583,"vcamInfo":"[]","videoSourcesOverlap":0}</textarea>
        <button onclick="testUserConfig()">æµ‹è¯•ç”¨æˆ·é…ç½®</button>
        <div id="userResult" class="result"></div>
    </div>

    <script>
        // å¤åˆ¶ä¿®å¤å‡½æ•°
        function fixNestedJsonEscaping(jsonStr) {
            console.log('ğŸ”§ å¼€å§‹ä¿®å¤åµŒå¥—JSONè½¬ä¹‰é—®é¢˜...');
            
            const nestedJsonFields = ['obsSourceInfo', 'sourceInfo', 'resolution', 'hackInfo'];
            let fixed = jsonStr;
            
            nestedJsonFields.forEach(fieldName => {
                const fieldPattern = new RegExp(`"${fieldName}"\\s*:\\s*"\\{`, 'g');
                
                if (fieldPattern.test(fixed)) {
                    console.log(`ğŸ”§ æ£€æµ‹åˆ°${fieldName}å­—æ®µéœ€è¦ä¿®å¤è½¬ä¹‰`);
                    fieldPattern.lastIndex = 0;
                    
                    const fieldMatch = fieldPattern.exec(fixed);
                    if (fieldMatch) {
                        const valueStart = fieldMatch.index + fieldMatch[0].length - 1;
                        
                        let braceCount = 0;
                        let inString = false;
                        let escapeNext = false;
                        let valueEnd = -1;
                        
                        for (let i = valueStart; i < fixed.length; i++) {
                            const char = fixed[i];
                            
                            if (escapeNext) {
                                escapeNext = false;
                                continue;
                            }
                            
                            if (char === '\\') {
                                escapeNext = true;
                                continue;
                            }
                            
                            if (char === '"' && !escapeNext) {
                                inString = !inString;
                                continue;
                            }
                            
                            if (!inString) {
                                if (char === '{') {
                                    braceCount++;
                                } else if (char === '}') {
                                    braceCount--;
                                    if (braceCount === 0) {
                                        for (let j = i + 1; j < fixed.length; j++) {
                                            if (fixed[j] === '"') {
                                                valueEnd = j;
                                                break;
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (valueEnd > valueStart) {
                            const nestedJsonStr = fixed.substring(valueStart, valueEnd);
                            const fixedNestedJson = nestedJsonStr.replace(/"/g, '\\"');
                            
                            const before = fixed.substring(0, valueStart);
                            const after = fixed.substring(valueEnd);
                            fixed = before + fixedNestedJson + after;
                            
                            console.log(`âœ… ${fieldName}å­—æ®µè½¬ä¹‰ä¿®å¤å®Œæˆ`);
                        }
                    }
                }
            });
            
            return fixed;
        }

        function parseNestedJsonField(jsonStr, fieldName) {
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                console.log(`ğŸ”§ ${fieldName}ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤è½¬ä¹‰:`, e.message);
                
                try {
                    let fixed = jsonStr;
                    if (!fixed.startsWith('{') && fixed.includes('{')) {
                        if (fixed.match(/^"?\{/)) {
                            fixed = fixed.replace(/^"/, '');
                            fixed = fixed.replace(/"$/, '');
                        }
                    }
                    
                    const result = JSON.parse(fixed);
                    console.log(`âœ… ${fieldName}ä¿®å¤åè§£ææˆåŠŸ`);
                    return result;
                } catch (e2) {
                    throw e2;
                }
            }
        }

        function testUserConfig() {
            const userConfig = document.getElementById('userConfig').value;
            const resultDiv = document.getElementById('userResult');
            
            try {
                console.log('ğŸ” å¼€å§‹æµ‹è¯•ç”¨æˆ·é…ç½®...');
                
                // å…ˆå°è¯•ç›´æ¥è§£æ
                try {
                    const directParse = JSON.parse(userConfig);
                    resultDiv.innerHTML = '<h4>âŒ æµ‹è¯•å¤±è´¥ï¼šç›´æ¥è§£æä¸åº”è¯¥æˆåŠŸ</h4>';
                    resultDiv.className = 'result error';
                    return;
                } catch (e) {
                    console.log('âœ… ç›´æ¥è§£æå¤±è´¥ï¼ˆç¬¦åˆé¢„æœŸï¼‰:', e.message);
                }
                
                // ä½¿ç”¨ä¿®å¤å‡½æ•°
                const fixedConfig = fixNestedJsonEscaping(userConfig);
                console.log('ğŸ”§ ä¿®å¤åçš„é…ç½®é•¿åº¦:', fixedConfig.length);
                
                // å°è¯•è§£æä¿®å¤åçš„é…ç½®
                const parsedData = JSON.parse(fixedConfig);
                console.log('âœ… ä¿®å¤åè§£ææˆåŠŸ');
                
                // æµ‹è¯•åµŒå¥—å­—æ®µ
                const obsSourceInfo = parseNestedJsonField(parsedData.obsSourceInfo, 'obsSourceInfo');
                const sourceInfo = parseNestedJsonField(parsedData.sourceInfo, 'sourceInfo');
                const resolution = parseNestedJsonField(parsedData.resolution, 'resolution');
                
                resultDiv.innerHTML = `
                    <h4>âœ… æµ‹è¯•æˆåŠŸï¼</h4>
                    <p><strong>ä¸»JSONè§£æ:</strong> æˆåŠŸ</p>
                    <p><strong>obsSourceInfoå­—æ®µ:</strong> ${Object.keys(obsSourceInfo).length}ä¸ªæºç±»å‹</p>
                    <p><strong>sourceInfoå­—æ®µ:</strong> ${Object.keys(sourceInfo).length}ä¸ªæºç±»å‹</p>
                    <p><strong>resolutionå­—æ®µ:</strong> ${resolution.width}x${resolution.height}</p>
                    <p><strong>obsSourceInfoä¸­çš„æºç±»å‹:</strong> ${Object.keys(obsSourceInfo).join(', ')}</p>
                    <p><strong>å›¾ç‰‡æºæ•°é‡:</strong> ${obsSourceInfo.image ? obsSourceInfo.image.length : 0}</p>
                    <p><strong>è§†é¢‘æºæ•°é‡:</strong> ${obsSourceInfo.video ? obsSourceInfo.video.length : 0}</p>
                    <p><strong>æ‘„åƒå¤´æºæ•°é‡:</strong> ${obsSourceInfo.camera ? obsSourceInfo.camera.length : 0}</p>
                    <p><strong>çª—å£æºæ•°é‡:</strong> ${obsSourceInfo.window ? obsSourceInfo.window.length : 0}</p>
                `;
                resultDiv.className = 'result success';
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>âŒ æµ‹è¯•å¤±è´¥</h4>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
                resultDiv.className = 'result error';
                console.error('æµ‹è¯•å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html> 