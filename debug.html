<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿›ç¨‹æ ‡ç­¾è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” è¿›ç¨‹æ ‡ç­¾åŒ¹é…è°ƒè¯•</h1>
    
    <div class="debug-info">
        <h3>æµ‹è¯•é…ç½®</h3>
        <p><strong>è¿›ç¨‹å:</strong> dnplayer.exe</p>
        <p><strong>æœŸæœ›æ ‡ç­¾:</strong> å®‰å“æ¨¡æ‹Ÿå™¨</p>
    </div>
    
    <button onclick="testProcessMatching()">ğŸ§ª å¼€å§‹æµ‹è¯•</button>
    
    <div id="results"></div>

    <script>
        let processLabelMap = {};
        let isProcessLibraryLoaded = false;

        // å¼‚æ­¥åŠ è½½è¿›ç¨‹åº“
        async function loadProcessLibrary() {
            try {
                console.log('ğŸ” å¼€å§‹åŠ è½½è¿›ç¨‹åº“...');
                const response = await fetch('process-library.csv');
                const csv = await response.text();
                
                console.log('ğŸ“„ CSVå†…å®¹å‰500å­—ç¬¦:', csv.substring(0, 500));
                
                const lines = csv.split('\n');
                console.log('ğŸ“„ CSVæ€»è¡Œæ•°:', lines.length);
                
                lines.slice(1).forEach((line, index) => {
                    if (line.trim()) {
                        const [exe, label] = line.split(',');
                        if (exe && label) {
                            const cleanExe = exe.trim().toLowerCase();
                            const cleanLabel = label.trim();
                            processLabelMap[cleanExe] = cleanLabel;
                            
                            // ç‰¹åˆ«å…³æ³¨dnplayer
                            if (cleanExe.includes('dnplayer')) {
                                console.log(`ğŸ¯ æ‰¾åˆ°dnplayerç›¸å…³è®°å½• (è¡Œ${index + 2}): "${exe}" -> "${label}"`);
                                console.log(`ğŸ¯ æ¸…ç†å: "${cleanExe}" -> "${cleanLabel}"`);
                            }
                        }
                    }
                });
                
                isProcessLibraryLoaded = true;
                console.log(`âœ… è¿›ç¨‹åº“åŠ è½½å®Œæˆï¼Œå…± ${Object.keys(processLabelMap).length} ä¸ªè¿›ç¨‹æ˜ å°„`);
                
                // æ£€æŸ¥dnplayeræ˜¯å¦åœ¨æ˜ å°„ä¸­
                if (processLabelMap['dnplayer']) {
                    console.log(`âœ… dnplayeræ˜ å°„æˆåŠŸ: ${processLabelMap['dnplayer']}`);
                } else {
                    console.log(`âŒ dnplayeræ˜ å°„å¤±è´¥`);
                    console.log('ğŸ” æ˜ å°„è¡¨ä¸­åŒ…å«dnplayerçš„é”®:', Object.keys(processLabelMap).filter(k => k.includes('dnplayer')));
                }
                
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½è¿›ç¨‹åº“å¤±è´¥:', error);
                return false;
            }
        }

        // æµ‹è¯•è¿›ç¨‹æ ‡ç­¾åŒ¹é…
        function getLayerDisplayName(exeName) {
            if (!exeName) return 'æ— è¿›ç¨‹å';
            
            // å»æ‰æ‰©å±•åï¼Œè½¬æ¢ä¸ºå°å†™
            const exeBase = exeName.replace(/\.[^/.]+$/, '').toLowerCase();
            
            console.log(`ğŸ” æŸ¥æ‰¾è¿›ç¨‹æ ‡ç­¾: ${exeName} -> ${exeBase}`);
            
            if (isProcessLibraryLoaded && processLabelMap[exeBase]) {
                const label = processLabelMap[exeBase];
                console.log(`âœ… æ‰¾åˆ°è¿›ç¨‹æ ‡ç­¾: ${exeBase} -> ${label}`);
                return label;
            } else {
                console.log(`âŒ æœªæ‰¾åˆ°è¿›ç¨‹æ ‡ç­¾: ${exeBase}, è¿›ç¨‹åº“å·²åŠ è½½: ${isProcessLibraryLoaded}`);
                
                // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºè¿›ç¨‹åº“ä¸­çš„ç›¸å…³æ¡ç›®
                if (isProcessLibraryLoaded) {
                    const allKeys = Object.keys(processLabelMap);
                    const similarKeys = allKeys.filter(key => 
                        key.includes(exeBase) || exeBase.includes(key)
                    );
                    console.log(`ğŸ” è¿›ç¨‹åº“ä¸­ç›¸ä¼¼çš„é”®: ${similarKeys.join(', ')}`);
                    console.log(`ğŸ” è¿›ç¨‹åº“ä¸­æ‰€æœ‰é”®çš„å‰10ä¸ª: ${allKeys.slice(0, 10).join(', ')}`);
                }
                
                return exeName; // è¿”å›åŸå§‹è¿›ç¨‹å
            }
        }

        // æµ‹è¯•å‡½æ•°
        async function testProcessMatching() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="debug-info">ğŸ”„ æ­£åœ¨æµ‹è¯•...</div>';
            
            console.log('ğŸ§ª å¼€å§‹è¿›ç¨‹æ ‡ç­¾åŒ¹é…æµ‹è¯•');
            
            // 1. åŠ è½½è¿›ç¨‹åº“
            const loadSuccess = await loadProcessLibrary();
            
            let html = '';
            
            if (loadSuccess) {
                html += '<div class="debug-info success"><h3>âœ… è¿›ç¨‹åº“åŠ è½½æˆåŠŸ</h3>';
                html += `<p>å…±åŠ è½½ ${Object.keys(processLabelMap).length} ä¸ªè¿›ç¨‹æ˜ å°„</p></div>`;
                
                // 2. æµ‹è¯•dnplayer.exe
                const testExe = 'dnplayer.exe';
                const result = getLayerDisplayName(testExe);
                
                if (result === 'å®‰å“æ¨¡æ‹Ÿå™¨') {
                    html += '<div class="debug-info success"><h3>ğŸ‰ æµ‹è¯•æˆåŠŸï¼</h3>';
                    html += `<p><strong>${testExe}</strong> æ­£ç¡®æ˜ å°„ä¸º <strong>${result}</strong></p></div>`;
                } else {
                    html += '<div class="debug-info error"><h3>âŒ æµ‹è¯•å¤±è´¥</h3>';
                    html += `<p><strong>${testExe}</strong> æ˜ å°„ä¸º <strong>${result}</strong>ï¼ŒæœŸæœ›ä¸º <strong>å®‰å“æ¨¡æ‹Ÿå™¨</strong></p></div>`;
                }
                
                // 3. æ˜¾ç¤ºæ˜ å°„è¯¦æƒ…
                html += '<div class="debug-info"><h3>ğŸ” æ˜ å°„è¯¦æƒ…</h3>';
                html += `<p><strong>åŸå§‹è¿›ç¨‹å:</strong> ${testExe}</p>`;
                html += `<p><strong>å¤„ç†åçš„é”®:</strong> ${testExe.replace(/\.[^/.]+$/, '').toLowerCase()}</p>`;
                html += `<p><strong>è¿›ç¨‹åº“ä¸­çš„å€¼:</strong> ${processLabelMap['dnplayer'] || 'æœªæ‰¾åˆ°'}</p>`;
                html += `<p><strong>è¿›ç¨‹åº“å·²åŠ è½½:</strong> ${isProcessLibraryLoaded}</p></div>`;
                
            } else {
                html += '<div class="debug-info error"><h3>âŒ è¿›ç¨‹åº“åŠ è½½å¤±è´¥</h3></div>';
            }
            
            resultsDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', function() {
            console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•');
            setTimeout(testProcessMatching, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
        });
    </script>
</body>
</html> 