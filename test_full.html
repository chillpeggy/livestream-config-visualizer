<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æµç¨‹æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-info { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .layer-item { background: #fff; border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        textarea { width: 100%; height: 150px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å®Œæ•´æµç¨‹æµ‹è¯•</h1>
    
    <div class="debug-info">
        <h3>æµ‹è¯•JSONé…ç½®</h3>
        <textarea id="jsonInput">{
  "resolution": "{\"width\":1920,\"height\":1080}",
  "sourceInfo": "{\"process\":{\"sourceList\":[{\"exeName\":\"dnplayer.exe\",\"overlap\":0.7,\"canvasOverlap\":0.7,\"canvasOverlapRect\":[791,156,341,195],\"layer\":1}]}}"
}</textarea>
    </div>
    
    <button onclick="testFullProcess()">ğŸš€ å®Œæ•´æµ‹è¯•</button>
    <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤ç»“æœ</button>
    
    <div id="results"></div>

    <script>
        let processLabelMap = {};
        let isProcessLibraryLoaded = false;
        let parsedLayers = [];

        // å¼‚æ­¥åŠ è½½è¿›ç¨‹åº“ (å¤åˆ¶è‡ªä¸»é¡µé¢)
        async function loadProcessLibrary() {
            try {
                const response = await fetch('process-library.csv');
                const csv = await response.text();
                
                console.log('ğŸ” å¼€å§‹åŠ è½½è¿›ç¨‹åº“...');
                
                csv.split('\n').slice(1).forEach(line => {
                    if (line.trim()) {
                        const [exe, label] = line.split(',');
                        if (exe && label) {
                            const cleanExe = exe.trim().toLowerCase();
                            const cleanLabel = label.trim();
                            processLabelMap[cleanExe] = cleanLabel;
                            console.log(`ğŸ“‹ è¿›ç¨‹æ˜ å°„: ${cleanExe} -> ${cleanLabel}`);
                        }
                    }
                });
                
                isProcessLibraryLoaded = true;
                console.log(`âœ… è¿›ç¨‹åº“åŠ è½½å®Œæˆï¼Œå…± ${Object.keys(processLabelMap).length} ä¸ªè¿›ç¨‹æ˜ å°„`);
                
                // å¦‚æœå·²ç»æœ‰è§£æçš„å›¾å±‚æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“å›¾å±‚åˆ—è¡¨
                if (parsedLayers.length > 0) {
                    console.log('ğŸ”„ è¿›ç¨‹åº“åŠ è½½å®Œæˆï¼Œé‡æ–°æ¸²æŸ“å›¾å±‚åˆ—è¡¨...');
                    generateLayerList();
                }
                
            } catch (error) {
                console.error('âŒ åŠ è½½è¿›ç¨‹åº“å¤±è´¥:', error);
            }
        }

        // getLayerDisplayNameå‡½æ•° (å¤åˆ¶è‡ªä¸»é¡µé¢)
        function getLayerDisplayName(layer) {
            // å¯¹äºè¿›ç¨‹ç±»å‹ï¼Œæ— è®ºæ˜¯ä¼´ä¾£é…ç½®è¿˜æ˜¯OBSé…ç½®ï¼Œéƒ½å°è¯•æŸ¥æ‰¾æ ‡ç­¾
            if (layer.sourceType === 'process' && layer.exeName) {
                // å»æ‰æ‰©å±•åï¼Œè½¬æ¢ä¸ºå°å†™
                const exeBase = layer.exeName.replace(/\.[^/.]+$/, '').toLowerCase();
                
                console.log(`ğŸ” æŸ¥æ‰¾è¿›ç¨‹æ ‡ç­¾: ${layer.exeName} -> ${exeBase}`);
                
                if (isProcessLibraryLoaded && processLabelMap[exeBase]) {
                    const label = processLabelMap[exeBase];
                    console.log(`âœ… æ‰¾åˆ°è¿›ç¨‹æ ‡ç­¾: ${exeBase} -> ${label}`);
                    return label;
                } else {
                    console.log(`âŒ æœªæ‰¾åˆ°è¿›ç¨‹æ ‡ç­¾: ${exeBase}, è¿›ç¨‹åº“å·²åŠ è½½: ${isProcessLibraryLoaded}`);
                    // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºè¿›ç¨‹åº“ä¸­çš„ç›¸å…³æ¡ç›®
                    if (isProcessLibraryLoaded) {
                        const similarKeys = Object.keys(processLabelMap).filter(key => 
                            key.includes(exeBase) || exeBase.includes(key)
                        );
                        console.log(`ğŸ” è¿›ç¨‹åº“ä¸­ç›¸ä¼¼çš„é”®: ${similarKeys.join(', ')}`);
                    }
                }
                
                // è¿›ç¨‹åº“æ‰¾ä¸åˆ°åˆ™ç”¨åŸå§‹è¿›ç¨‹å
                return layer.exeName;
            }
            
            // å¯¹äºOBSé…ç½®ï¼Œä¼˜å…ˆæ˜¾ç¤ºnameå­—æ®µ
            if (layer.configSource === 'obs') {
                if (layer.name && layer.name.trim()) {
                    return layer.name;
                }
            }
            
            // å…¶ä»–ç±»å‹ä¿æŒåŸæœ‰é€»è¾‘
            return layer.name || layer.sourceType;
        }

        // è§£æsourceInfoæ ¼å¼ (ç®€åŒ–ç‰ˆ)
        function parseSourceInfo(sourceInfo) {
            Object.keys(sourceInfo).forEach(sourceType => {
                const sourceData = sourceInfo[sourceType];
                if (sourceData.sourceList) {
                    sourceData.sourceList.forEach(source => {
                        parsedLayers.push({
                            ...source,
                            sourceType,
                            configSource: 'douyin',
                            name: source.name || source.exeName || source.fileName || `${sourceType}æº`
                        });
                    });
                }
            });
        }

        // ç”Ÿæˆå›¾å±‚åˆ—è¡¨ (ç®€åŒ–ç‰ˆ)
        function generateLayerList() {
            let html = '<div class="debug-info"><h3>ğŸ“‹ è§£æçš„å›¾å±‚åˆ—è¡¨</h3>';
            
            parsedLayers.forEach(layer => {
                const displayName = getLayerDisplayName(layer);
                const isCorrect = (layer.exeName === 'dnplayer.exe' && displayName === 'å®‰å“æ¨¡æ‹Ÿå™¨');
                
                html += `<div class="layer-item ${isCorrect ? 'success' : 'error'}">`;
                html += `<strong>ç¬¬${layer.layer}å±‚ - ${displayName}</strong><br>`;
                html += `åŸå§‹è¿›ç¨‹å: ${layer.exeName}<br>`;
                html += `é…ç½®æ¥æº: ${layer.configSource}<br>`;
                html += `æºç±»å‹: ${layer.sourceType}`;
                html += `</div>`;
            });
            
            html += '</div>';
            return html;
        }

        // å®Œæ•´æµ‹è¯•æµç¨‹
        async function testFullProcess() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="debug-info">ğŸ”„ å¼€å§‹å®Œæ•´æµ‹è¯•...</div>';
            
            let html = '';
            
            try {
                // 1. åŠ è½½è¿›ç¨‹åº“
                html += '<div class="debug-info">ğŸ“š æ­¥éª¤1: åŠ è½½è¿›ç¨‹åº“...</div>';
                await loadProcessLibrary();
                
                if (isProcessLibraryLoaded) {
                    html += '<div class="debug-info success">âœ… è¿›ç¨‹åº“åŠ è½½æˆåŠŸ</div>';
                } else {
                    html += '<div class="debug-info error">âŒ è¿›ç¨‹åº“åŠ è½½å¤±è´¥</div>';
                    resultsDiv.innerHTML = html;
                    return;
                }
                
                // 2. è§£æJSONé…ç½®
                html += '<div class="debug-info">ğŸ”§ æ­¥éª¤2: è§£æJSONé…ç½®...</div>';
                const jsonInput = document.getElementById('jsonInput').value;
                const data = JSON.parse(jsonInput);
                
                // è§£æresolution
                const canvasResolution = JSON.parse(data.resolution);
                console.log('è§£æåˆ†è¾¨ç‡:', canvasResolution);
                
                // è§£æsourceInfo
                parsedLayers = [];
                if (data.sourceInfo) {
                    const sourceInfoData = JSON.parse(data.sourceInfo);
                    parseSourceInfo(sourceInfoData);
                }
                
                html += '<div class="debug-info success">âœ… JSONè§£ææˆåŠŸ</div>';
                html += `<div class="debug-info">è§£æåˆ° ${parsedLayers.length} ä¸ªå›¾å±‚</div>`;
                
                // 3. ç”Ÿæˆå›¾å±‚åˆ—è¡¨
                html += '<div class="debug-info">ğŸ¨ æ­¥éª¤3: ç”Ÿæˆå›¾å±‚æ˜¾ç¤ºåç§°...</div>';
                html += generateLayerList();
                
                // 4. éªŒè¯ç»“æœ
                const dnplayerLayer = parsedLayers.find(layer => layer.exeName === 'dnplayer.exe');
                if (dnplayerLayer) {
                    const displayName = getLayerDisplayName(dnplayerLayer);
                    if (displayName === 'å®‰å“æ¨¡æ‹Ÿå™¨') {
                        html += '<div class="debug-info success"><h3>ğŸ‰ æµ‹è¯•æˆåŠŸï¼</h3>';
                        html += `dnplayer.exe æ­£ç¡®æ˜¾ç¤ºä¸º "å®‰å“æ¨¡æ‹Ÿå™¨"</div>`;
                    } else {
                        html += '<div class="debug-info error"><h3>âŒ æµ‹è¯•å¤±è´¥</h3>';
                        html += `dnplayer.exe æ˜¾ç¤ºä¸º "${displayName}"ï¼ŒæœŸæœ›ä¸º "å®‰å“æ¨¡æ‹Ÿå™¨"</div>`;
                    }
                }
                
            } catch (error) {
                html += `<div class="debug-info error">âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}</div>`;
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
            
            resultsDiv.innerHTML = html;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            parsedLayers = [];
        }

        // é¡µé¢åŠ è½½æ—¶å¼€å§‹åŠ è½½è¿›ç¨‹åº“
        loadProcessLibrary();
    </script>
</body>
</html> 