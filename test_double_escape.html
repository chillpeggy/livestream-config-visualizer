<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒé‡è½¬ä¹‰ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        textarea { width: 100%; height: 200px; font-family: monospace; font-size: 11px; }
        button { padding: 10px 20px; margin: 10px 0; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; font-family: monospace; font-size: 12px; }
        .log { background: #f1f3f4; padding: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>åŒé‡è½¬ä¹‰ä¿®å¤åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-case">
        <h3>æµ‹è¯•ç”¨ä¾‹ï¼šç”¨æˆ·æä¾›çš„åŒé‡è½¬ä¹‰é…ç½®</h3>
        <textarea id="doubleEscapeConfig">{"anglogSourceOverlap":0,"cameraSourceOverlap":0,"hackInfo":"{\"hackExe\":\"obs64.exe\",\"hackExePath\":\"D:\\\\obs-studio\\\\bin\\\\64bit\\\\obs64.exe\",\"hackRemotePort\":1935,\"roomId\":\"7522380260442835752\"}","hangupVersion":10,"isMirroring":false,"isVirtualIdol":false,"liveMode":0,"micDecible":-0.01,"micDecibleList":"[-1.32,-46.56,-3.08,-0.88,-38.58,-39.04,-40.04,-33.57,0,-3.91,-37.44,-17.78,-5.76,-10.51,-26.8,-16.68,-27.83,-38.81,-1.1,-41.37,-38.05,-39.02,-1.25,-9.08,-28.28,-1.44,-28.55,-39.38,-8.89,-44.55]","obsSourceInfo":"{\"audio\":[{\"deviceId\":\"{0.0.1.00000000}.{64aa2605-b327-4082-8273-d044d89e2948}\",\"name\":\"æ¸¸æˆ\",\"pos\":{\"x\":0,\"y\":0},\"volume\":1}],\"auxAudioVolumn\":1,\"camera\":[{\"deviceId\":\"Piva-VD05\",\"isSoftware\":false,\"name\":\"è‹¹æœå¹³æ¿\",\"pos\":{\"x\":0,\"y\":0},\"realDeviceId\":\"\\\\\\\\?\\\\usb#22vid_048d\\u0026pid_9335\\u0026mi_00#228\\u0026289e0d86\\u00260\\u00260000#22{65e8773d-8f56-11d0-a3b9-00a0c9223196}\\\\global\",\"volume\":1}],\"desktopAudioVolumn\":1,\"image\":[{\"fileSize\":175744,\"filepath\":\"D:/åä¸‰å®šåˆ¶æ¸¸æˆlutåˆé›†å‹¿åˆ /é»‘è¾¹/é»‘è¾¹-å‹¿åˆ .jpg\",\"name\":\"é»‘è¾¹\",\"pos\":{\"x\":0,\"y\":0}},{\"fileSize\":5533,\"filepath\":\"D:/åä¸‰å®šåˆ¶æ¸¸æˆlutåˆé›†å‹¿åˆ /é»‘è¾¹/çš‡å† å›¾.gif\",\"name\":\"çš‡å† \",\"pos\":{\"x\":56,\"y\":1729}},{\"fileSize\":164582,\"filepath\":\"C:/Users/Administrator/Desktop/æ‰«ç .jpg\",\"name\":\"æ‰«ç é®æŒ¡å›¾\",\"pos\":{\"x\":789,\"y\":448}}],\"video\":[{\"fileSize\":180858,\"filepath\":\"C:/Users/Administrator/Desktop/ç»¿å¹•ç´ æ.mp4\",\"looping\":true,\"name\":\"èœ¡ç¬”å°æ–°\",\"pos\":{\"x\":0,\"y\":1715},\"volume\":1}],\"window\":[{\"exeName\":\"å’Œå¹³ç²¾è‹±:Qt5152QWindowIcon:GameAssistEmulator.exe\",\"name\":\"å®‰å“ç³»ç»Ÿ\",\"pos\":{\"x\":0,\"y\":0}},{\"exeName\":\"å’Œå¹³ç²¾è‹±æ¨¡æ‹Ÿå™¨é«˜æ¸…ç‰ˆ:UnrealWindow:hpjyhd.exe\",\"name\":\"å®‰å“é«˜æ¸…æ¨¡æ‹Ÿå™¨\",\"pos\":{\"x\":1.2427184581756592,\"y\":0}},{\"exeName\":\"x.:Qt5152QWindowIcon:i4AirPlayer.exe\",\"name\":\"éœ²è„¸\",\"pos\":{\"x\":0,\"y\":1207}}]}","pcSpeakerDecibel":-29.33,"resolution":"{\"height\":1440,\"width\":1920}","sourceInfo":"{\"window\":{\"sourceList\":[{\"canvasOverlap\":0,\"canvasOverlapRect\":[0,0,3,361.71],\"exeName\":\"obs64.exe\",\"layer\":0,\"overlap\":0}],\"totalOverlap\":0}}","timestamp":1751442577,"vcamInfo":"[]","videoSourcesOverlap":0}</textarea>
        <button onclick="testDoubleEscape()">æµ‹è¯•åŒé‡è½¬ä¹‰ä¿®å¤</button>
        <div id="doubleEscapeResult" class="result"></div>
    </div>

    <div class="test-case">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        let testLog = [];

        function log(message) {
            testLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('testLog').innerHTML = testLog.join('\n');
            console.log(message);
        }

        // å¤åˆ¶ä¿®å¤å‡½æ•°
        function fixDoubleEscaping(jsonStr) {
            log('ğŸ”§ æ£€æŸ¥åŒé‡è½¬ä¹‰é—®é¢˜...');
            
            if (jsonStr.startsWith('{\\')) {
                log('ğŸ”§ æ£€æµ‹åˆ°åŒé‡è½¬ä¹‰ï¼Œè¿›è¡Œä¿®å¤...');
                
                try {
                    const unescaped = JSON.parse('"' + jsonStr + '"');
                    log('âœ… åŒé‡è½¬ä¹‰ä¿®å¤æˆåŠŸ');
                    log('ä¿®å¤åå‰100å­—ç¬¦: ' + unescaped.substring(0, 100));
                    return unescaped;
                } catch (e) {
                    log('âš ï¸ åŒé‡è½¬ä¹‰ä¿®å¤å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•: ' + e.message);
                    
                    let fixed = jsonStr;
                    fixed = fixed.replace(/\\"/g, '"');
                    fixed = fixed.replace(/\\\\/g, '\\');
                    
                    log('ğŸ”§ æ‰‹åŠ¨åŒé‡è½¬ä¹‰ä¿®å¤å®Œæˆ');
                    log('æ‰‹åŠ¨ä¿®å¤åå‰100å­—ç¬¦: ' + fixed.substring(0, 100));
                    return fixed;
                }
            }
            
            return jsonStr;
        }

        function parseNestedJsonField(jsonStr, fieldName) {
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                log(`ğŸ”§ ${fieldName}ç›´æ¥è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤è½¬ä¹‰: ${e.message}`);
                
                try {
                    let fixed = jsonStr;
                    if (!fixed.startsWith('{') && fixed.includes('{')) {
                        if (fixed.match(/^"?\{/)) {
                            fixed = fixed.replace(/^"/, '');
                            fixed = fixed.replace(/"$/, '');
                        }
                    }
                    
                    const result = JSON.parse(fixed);
                    log(`âœ… ${fieldName}ä¿®å¤åè§£ææˆåŠŸ`);
                    return result;
                } catch (e2) {
                    throw e2;
                }
            }
        }

        function testDoubleEscape() {
            const configText = document.getElementById('doubleEscapeConfig').value;
            const resultDiv = document.getElementById('doubleEscapeResult');
            
            log('\nğŸ§ª å¼€å§‹æµ‹è¯•åŒé‡è½¬ä¹‰ä¿®å¤...');
            log('åŸå§‹å­—ç¬¦ä¸²å‰100å­—ç¬¦: ' + configText.substring(0, 100));
            
            try {
                // å…ˆå°è¯•ç›´æ¥è§£æ
                try {
                    const directParse = JSON.parse(configText);
                    log('âœ… ç›´æ¥è§£ææˆåŠŸï¼ˆä¸éœ€è¦ä¿®å¤ï¼‰');
                    
                    // æµ‹è¯•åµŒå¥—å­—æ®µ
                    testNestedFields(directParse, resultDiv, 'ç›´æ¥è§£æ');
                    return;
                } catch (e) {
                    log('âš ï¸ ç›´æ¥è§£æå¤±è´¥: ' + e.message);
                }
                
                // ä½¿ç”¨åŒé‡è½¬ä¹‰ä¿®å¤
                const fixedConfig = fixDoubleEscaping(configText);
                log('ğŸ”§ åŒé‡è½¬ä¹‰ä¿®å¤å®Œæˆï¼Œå°è¯•è§£æ...');
                
                const parsedData = JSON.parse(fixedConfig);
                log('âœ… ä¿®å¤åJSONè§£ææˆåŠŸ');
                
                // æµ‹è¯•åµŒå¥—å­—æ®µ
                testNestedFields(parsedData, resultDiv, 'ä¿®å¤åè§£æ');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>âŒ æµ‹è¯•å¤±è´¥</h4>
                    <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                `;
                resultDiv.className = 'result error';
                log('ğŸ’¥ æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        function testNestedFields(data, resultDiv, method) {
            const tests = [];
            
            if (data.obsSourceInfo) {
                try {
                    const obsData = parseNestedJsonField(data.obsSourceInfo, 'obsSourceInfo');
                    tests.push(`obsSourceInfo: ${Object.keys(obsData).length}ä¸ªæºç±»å‹`);
                    
                    // è¯¦ç»†åˆ†ææº
                    if (obsData.audio) tests.push(`- éŸ³é¢‘æº: ${obsData.audio.length}ä¸ª`);
                    if (obsData.camera) tests.push(`- æ‘„åƒå¤´æº: ${obsData.camera.length}ä¸ª`);
                    if (obsData.image) tests.push(`- å›¾ç‰‡æº: ${obsData.image.length}ä¸ª`);
                    if (obsData.video) tests.push(`- è§†é¢‘æº: ${obsData.video.length}ä¸ª`);
                    if (obsData.window) tests.push(`- çª—å£æº: ${obsData.window.length}ä¸ª`);
                    
                } catch (e) {
                    tests.push(`obsSourceInfo: è§£æå¤±è´¥ - ${e.message}`);
                }
            }
            
            if (data.sourceInfo) {
                try {
                    const sourceData = parseNestedJsonField(data.sourceInfo, 'sourceInfo');
                    tests.push(`sourceInfo: ${Object.keys(sourceData).length}ä¸ªæºç±»å‹`);
                } catch (e) {
                    tests.push(`sourceInfo: è§£æå¤±è´¥ - ${e.message}`);
                }
            }
            
            if (data.resolution) {
                try {
                    const resolutionData = parseNestedJsonField(data.resolution, 'resolution');
                    tests.push(`resolution: ${resolutionData.width}x${resolutionData.height}`);
                } catch (e) {
                    tests.push(`resolution: è§£æå¤±è´¥ - ${e.message}`);
                }
            }
            
            if (data.hackInfo) {
                try {
                    const hackData = parseNestedJsonField(data.hackInfo, 'hackInfo');
                    tests.push(`hackInfo: ${Object.keys(hackData).length}ä¸ªå­—æ®µ`);
                    if (hackData.hackExe) tests.push(`- æ‰§è¡Œæ–‡ä»¶: ${hackData.hackExe}`);
                    if (hackData.roomId) tests.push(`- æˆ¿é—´ID: ${hackData.roomId}`);
                } catch (e) {
                    tests.push(`hackInfo: è§£æå¤±è´¥ - ${e.message}`);
                }
            }
            
            resultDiv.innerHTML = `
                <h4>âœ… åŒé‡è½¬ä¹‰ä¿®å¤æµ‹è¯•æˆåŠŸ</h4>
                <p><strong>è§£ææ–¹æ³•:</strong> ${method}</p>
                <p><strong>ä¸»å­—æ®µæ•°é‡:</strong> ${Object.keys(data).length}</p>
                <p><strong>åµŒå¥—å­—æ®µæµ‹è¯•:</strong></p>
                <ul>${tests.map(test => `<li>${test}</li>`).join('')}</ul>
            `;
            resultDiv.className = 'result success';
            
            log('ğŸ‰ åŒé‡è½¬ä¹‰æµ‹è¯•æˆåŠŸå®Œæˆ');
        }

        // åˆå§‹åŒ–
        log('ğŸ“‹ åŒé‡è½¬ä¹‰æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
    </script>
</body>
</html> 